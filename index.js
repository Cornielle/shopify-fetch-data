let base64 = require('base-64');
const { Console } = require('console');
require('dotenv').config();
let fs = require('fs');
const fetch = require('node-fetch');
const shopify = require('./shopify')
global.Headers = fetch.Headers;
let headers = new Headers();
// headers.set(
//     'Authorization', 'Basic ' + base64.encode( process.env.USER_NAME+ ":" + process.env.PASSWORD),
//     'Content-Type','application/json',
//     'Accept', 'application/json'
//     );



query = `{
    orders(
        first:250,
        query:"created_at:>2020-03-01"
    ) {
        pageInfo {
          hasNextPage
        }
        edges {
          cursor
          node {
            id,
            createdAt
            customer{
                firstName
                lastName
            }
          }
        }
      }
  }`

let orders = require('./orders502.json');
let order
let IntervalTime
let orderArray = []

// const IDS = ['2372664328258 2020-07-27T15:55:58-04:00'
// ,'2372498227266 2020-07-27T14:30:06-04:00'
// ,'2372414767170 2020-07-27T13:45:09-04:00'
// ,'2372372955202 2020-07-27T13:22:03-04:00'
// ,'2372221927490 2020-07-27T12:01:42-04:00'
// ,'2372141023298 2020-07-27T11:17:45-04:00'
// ,'2372114219074 2020-07-27T11:02:23-04:00'
// ,'2372020076610 2020-07-27T10:04:20-04:00'
// ,'2371899293762 2020-07-27T08:24:59-04:00'
// ,'2371448045634 2020-07-27T00:13:58-04:00'
// ,'2371279454274 2020-07-26T21:51:12-04:00'
// ,'2371135373378 2020-07-26T19:59:11-04:00'
// ,'2371083075650 2020-07-26T19:15:00-04:00'
// ,'2371076849730 2020-07-26T19:11:26-04:00'
// ,'2370985295938 2020-07-26T18:01:32-04:00'
// ,'2370953674818 2020-07-26T17:40:23-04:00'
// ,'2370945482818 2020-07-26T17:34:31-04:00'
// ,'2370881486914 2020-07-26T16:54:56-04:00'
// ,'2370785116226 2020-07-26T15:58:40-04:00'
// ,'2370757099586 2020-07-26T15:43:03-04:00'
// ,'2370757066818 2020-07-26T15:43:02-04:00'
// ,'2370600894530 2020-07-26T14:15:30-04:00'
// ,'2370539290690 2020-07-26T13:41:49-04:00'
// ,'2370227109954 2020-07-26T10:25:58-04:00'
// ,'2370212167746 2020-07-26T10:14:15-04:00'
// ,'2369494057026 2020-07-25T21:59:48-04:00'
// ,'2369406074946 2020-07-25T20:48:11-04:00'
// ,'2369373110338 2020-07-25T20:23:16-04:00'
// ,'2369236074562 2020-07-25T18:53:09-04:00'
// ,'2369017741378 2020-07-25T16:45:28-04:00'
// ,'2369012498498 2020-07-25T16:42:37-04:00'
// ,'2369011449922 2020-07-25T16:42:01-04:00'
// ,'2368992837698 2020-07-25T16:32:26-04:00'
// ,'2368875724866 2020-07-25T15:37:28-04:00'
// ,'2368793641026 2020-07-25T15:02:14-04:00'
// ,'2368687177794 2020-07-25T14:09:09-04:00'
// ,'2368626884674 2020-07-25T13:38:05-04:00'
// ,'2368521666626 2020-07-25T12:46:31-04:00'
// ,'2368510427202 2020-07-25T12:40:12-04:00'
// ,'2368407404610 2020-07-25T11:50:56-04:00'
// ,'2368313622594 2020-07-25T11:00:33-04:00'
// ,'2368239206466 2020-07-25T10:16:20-04:00'
// ,'2368154075202 2020-07-25T09:15:42-04:00'
// ,'2367506972738 2020-07-24T21:59:46-04:00'
// ,'2367447400514 2020-07-24T21:14:49-04:00'
// ,'2367405523010 2020-07-24T20:45:19-04:00'
// ,'2367263670338 2020-07-24T19:08:36-04:00'
// ,'2367210029122 2020-07-24T18:33:16-04:00'
// ,'2367156912194 2020-07-24T18:03:29-04:00'
// ,'2367147737154 2020-07-24T17:59:07-04:00'
// ,'2367046418498 2020-07-24T17:02:23-04:00'
// ,'2367024627778 2020-07-24T16:50:37-04:00'
// ,'2366848958530 2020-07-24T15:14:41-04:00'
// ,'2366759698498 2020-07-24T14:28:41-04:00'
// ,'2366660640834 2020-07-24T13:38:09-04:00'
// ,'2366578884674 2020-07-24T12:59:03-04:00'
// ,'2366561812546 2020-07-24T12:49:38-04:00'
// ,'2366499422274 2020-07-24T12:19:02-04:00'
// ,'2366486642754 2020-07-24T12:13:55-04:00'
// ,'2366274011202 2020-07-24T10:21:12-04:00'
// ,'2366224957506 2020-07-24T09:53:10-04:00'
// ,'2365816012866 2020-07-24T03:31:58-04:00'
// ,'2365591486530 2020-07-23T23:33:30-04:00'
// ,'2365501440066 2020-07-23T22:24:05-04:00'
// ,'2365437444162 2020-07-23T21:40:23-04:00'
// ,'2365027123266 2020-07-23T17:21:59-04:00'
// ,'2364805808194 2020-07-23T15:33:22-04:00'
// ,'2364715794498 2020-07-23T14:50:35-04:00'
// ,'2364658614338 2020-07-23T14:21:35-04:00'
// ,'2364627157058 2020-07-23T14:06:31-04:00'
// ,'2364609232962 2020-07-23T13:57:02-04:00'
// ,'2364559523906 2020-07-23T13:32:17-04:00'
// ,'2364491759682 2020-07-23T13:02:09-04:00'
// ,'2364337061954 2020-07-23T11:39:46-04:00'
// ,'2364223389762 2020-07-23T10:38:24-04:00'
// ,'2364049948738 2020-07-23T08:38:46-04:00'
// ,'2363935096898 2020-07-23T06:48:20-04:00'
// ,'2363537293378 2020-07-22T23:38:17-04:00'
// ,'2363396751426 2020-07-22T21:42:24-04:00'
// ,'2363366670402 2020-07-22T21:33:28-04:00'
// ,'2362714718274 2020-07-22T21:27:39-04:00'
// ,'2361271156802 2020-07-22T19:52:45-04:00'
// ,'2361184354370 2020-07-22T18:54:20-04:00'
// ,'2360976441410 2020-07-22T16:57:13-04:00'
// ,'2360969494594 2020-07-22T16:52:48-04:00'
// ,'2360875843650 2020-07-22T16:01:33-04:00'
// ,'2360734187586 2020-07-22T14:45:42-04:00'
// ,'2360727076930 2020-07-22T14:41:36-04:00'
// ,'2360640536642 2020-07-22T13:58:12-04:00'
// ,'2360590467138 2020-07-22T13:32:17-04:00'
// ,'2360577097794 2020-07-22T13:24:49-04:00'
// ,'2360453824578 2020-07-22T12:25:41-04:00'
// ,'2360437932098 2020-07-22T12:18:15-04:00'
// ,'2360269897794 2020-07-22T10:58:29-04:00'
// ,'2360229265474 2020-07-22T10:35:23-04:00'
// ,'2360193220674 2020-07-22T10:12:17-04:00'
// ,'2360037212226 2020-07-22T08:09:17-04:00'
// ,'2359510073410 2020-07-21T22:32:56-04:00'
// ,'2359389421634 2020-07-21T21:02:19-04:00'
// ,'2359359275074 2020-07-21T20:41:10-04:00'
// ,'2359341678658 2020-07-21T20:27:55-04:00'
// ,'2359340662850 2020-07-21T20:27:06-04:00'
// ,'2359335059522 2020-07-21T20:23:08-04:00'
// ,'2359289544770 2020-07-21T19:50:50-04:00'
// ,'2359180165186 2020-07-21T18:33:25-04:00'
// ,'2359149035586 2020-07-21T18:13:54-04:00'
// ,'2358988406850 2020-07-21T16:38:46-04:00'
// ,'2358972514370 2020-07-21T16:29:31-04:00'
// ,'2358616653890 2020-07-21T13:17:48-04:00'
// ,'2358592733250 2020-07-21T13:05:34-04:00'
// ,'2358549938242 2020-07-21T12:40:47-04:00'
// ,'2358458810434 2020-07-21T11:47:34-04:00'
// ,'2358436560962 2020-07-21T11:34:44-04:00'
// ,'2358427058242 2020-07-21T11:29:06-04:00'
// ,'2358362243138 2020-07-21T10:50:37-04:00'
// ,'2358347268162 2020-07-21T10:41:37-04:00'
// ,'2357607170114 2020-07-20T22:21:02-04:00'
// ,'2357395324994 2020-07-20T19:47:15-04:00'
// ,'2357173321794 2020-07-20T17:15:43-04:00'
// ,'2357165031490 2020-07-20T17:11:37-04:00'
// ,'2357128495170 2020-07-20T16:50:26-04:00'
// ,'2357089927234 2020-07-20T16:28:30-04:00'
// ,'2357025308738 2020-07-20T15:55:12-04:00'
// ,'2356967473218 2020-07-20T15:25:45-04:00'
// ,'2356806975554 2020-07-20T14:04:19-04:00'
// ,'2356743995458 2020-07-20T13:31:11-04:00'
// ,'2356730232898 2020-07-20T13:23:59-04:00'
// ,'2356724400194 2020-07-20T13:20:45-04:00'
// ,'2356644151362 2020-07-20T12:37:37-04:00'
// ,'2356632617026 2020-07-20T12:31:37-04:00'
// ,'2356487061570 2020-07-20T11:08:04-04:00'
// ,'2356458913858 2020-07-20T10:50:33-04:00'
// ,'2356436729922 2020-07-20T10:35:40-04:00'
// ,'2356334592066 2020-07-20T09:25:17-04:00'
// ,'2356309262402 2020-07-20T09:06:58-04:00'
// ,'2356275314754 2020-07-20T08:36:43-04:00'
// ,'2356256669762 2020-07-20T08:19:13-04:00'
// ,'2356245102658 2020-07-20T08:08:05-04:00'
// ,'2355804045378 2020-07-19T23:47:38-04:00'
// ,'2355750436930 2020-07-19T22:59:36-04:00'
// ,'2355594035266 2020-07-19T20:56:40-04:00'
// ,'2355578011714 2020-07-19T20:43:44-04:00'
// ,'2355526467650 2020-07-19T20:06:39-04:00'
// ,'2355435798594 2020-07-19T18:55:23-04:00'
// ,'2355257376834 2020-07-19T16:54:28-04:00'
// ,'2355024396354 2020-07-19T14:44:15-04:00'
// ,'2354845122626 2020-07-19T13:04:11-04:00'
// ,'2354339020866 2020-07-19T06:24:07-04:00'
// ,'2354126585922 2020-07-19T02:05:53-04:00'
// ,'2353887969346 2020-07-18T21:58:45-04:00']


function setTransactions(id, mode){
    if(mode==='transaction'){
        let urlTransactions = `https://plaza-lama-virtual.myshopify.com/admin/api/2020-07/orders/${id}/transactions.json`;
        fetch(urlTransactions,{method:'GET', headers:headers})
        .then(response => response.json())
        .then(data => {
            orders.map(x=>{
                data.transactions.map(y=>{
                    if(id===x.orden && y.status ==='success'){
                        x['autorizacion'] = y.authorization
                        x['status'] = y.status
                        console.log(x.orden, x.autorizacion)
                        orderArray.push(x)
                    } else if(y.status === 'pending'&& id === x.orden){
                        x['autorizacion'] = y.authorization
                        x['status'] = y.status
                        orderArray.push(x)
                    }
                })
            })
            fs.writeFile("ordersFinal.json", JSON.stringify(orderArray), function(err) {
                    if (err) {
                        console.log(err);
                    }
                });
            });
            console.log(orderArray, 'empty?')
            console.log(IDS.length, 'vacio?')
            IDS.shift()
    }
    /*Ordenes*/
    if(mode==='orders'){
        let urlOrders = `https://plaza-lama-virtual.myshopify.com/admin/api/2020-07/orders/${id}.json`;
        fetch(urlOrders,{method:'GET', headers:headers})
        .then(response => response.json())
        .then(data => {
            console.log(IDS.length,'transacciones')
            let quantity = 0
            if(data.order.line_items ===undefined){
                console.log(data.order.id, 'quedo hasta aqui')
                clearInterval(IntervalTime)
            }
            quantity = data.order.line_items.length
            data.order.line_items.map(items=>{
                if(items ===undefined){
                    console.log(items)
                    return
                }
                console.log(items.sku,'checking')
            order = {
                fecha:data.order.created_at,
                orden:id,
                nombres:data.order.customer.first_name,
                apellidos:data.order.customer.last_name,
                cantidad:items.quantity,
                sku:items.sku,
                nombre_orden:data.order.name,
                precio:items.price,
                total_price:data.order.total_price,
                cantidadTotal:quantity,
            }
            orderArray.push(order)
            })
            console.log(orderArray);
            console.log(IDS.length,'transacciones')
            IDS.shift()
                fs.writeFile("orders502.json", JSON.stringify(orderArray), function(err) {
                    if (err) {
                        console.log(err);
                    }
                });
            })
            .catch(err=> console.log(err));
    }
    /*Ordenes por Fecha*/
    if(mode==='getOrdersByDate'){
        let urlOrders = `https://plaza-lama-virtual.myshopify.com/admin/api/2020-10/graphql.json`;
        shopify.autoFetch(urlOrders,{
            method:'POST', 
            headers: {
                'Content-Type': 'application/graphql',
                'X-Shopify-Access-Token':process.env.TOKEN
            }
        })
    }
}
// IntervalTime =  setInterval(function(){
    setTransactions('', 'getOrdersByDate')
    // setTransactions(IDS[0].substring(0,13), 'transaction')
    // }, 2600);
